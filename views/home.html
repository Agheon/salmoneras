{{!< layout/default}}

{{#extend "css"}}
<style>
</style>
{{/extend}}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="dropdown">
                <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="dropdownTools" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-wrench"></i> HERRAMIENTAS
                </a>

                <div class="dropdown-menu" aria-labelledby="dropdownTools">
                    <a id="" class="dropdown-item" href="#">SIN HERRAMIENTAS</a>
                </div>
            </div>
            <center><h1><span id="enterpriseName"></span> <a data-container="body" data-toggle="popover" data-placement="left" href="#" id="changeDates" role="button" class="btn btn-primary "><i class="far fa-calendar-alt"></i> CAMBIAR FECHAS  <span id="dateSelected" ></span></a></h1></center>
            <br>
        </div>
    </div>
    
    <div id="totalData"></div>
    <div class="row" id="foreachCenter"></div>
</div>

<div class="modal fade" id="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal_body"></div>
            <div class="modal-footer" id="modal_footer"></div>
        </div>
    </div>
</div>
{{#extend "js"}}
<script>
let initDate = moment().format('YYYY-MM-DD')
let endDate = moment().format('YYYY-MM-DD')
let fullData = {}

$(document).ready(function() {
    selectNav('nav-dashboard')
    $('#dateSelected').html(moment().format('DD/MM/YYYY'))
    getCredentials().then(credentials=>{
        $('#enterpriseName').html(credentials.enterprise.toUpperCase())
    })

    getFullData()
})

$('#changeDates').on('click', function() {
    $('#modal').modal('show')

    $('#modal_title').html(`<i class="fas fa-calendar-alt"></i> Rango de fechas`)

    $('#modal_body').html(`
        <div class="card">
            <div class="card-body">
                <center><h4 class="card-title">Fechas: Desde Hasta</h4></center>
                <input style="font-size: 30px; text-align:center;" class="form-control" id="rangeDate" type="text" name="daterange" /> 
            </div>
        </div>  
    `)

    $('#modal_footer').html(`
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="rangeReport">Consultar rango</button>
    `)

    $('#rangeDate').daterangepicker({
        opens: 'top',
        startDate: moment(initDate).format('DD/MM/YYYY'),
        endDate: moment(endDate).format('DD/MM/YYYY'),
        locale: {
            applyLabel: 'Aplicar',
            cancelLabel: 'Cancelar',
            format: 'DD/MM/YYYY',
            daysOfWeek: [
                'Dom',
                'Lun',
                'Mar',
                'Mie',
                'Jue',
                'Vie',
                'Sab'
            ],
            monthNames: [
                'Enero',
                'Febrero',
                'Marzo',
                'Abril',
                'Mayo',
                'Junio',
                'Julio',
                'Agosto',
                'Septiembre',
                'Octubre',
                'Noviembre',
                'Diciembre'
            ],
            firstDay: 1
        }
    }, function(start, end, label) {
        initDate = start.format('YYYY-MM-DD')
        endDate = end.format('YYYY-MM-DD')
    })

    $('#rangeReport').on('click', function(){
        getFullData()
    })
})

const getFullData = () => {
    console.log(initDate, endDate)

    $('#modal').modal('hide')
    if(initDate == endDate) {
        $('#dateSelected').html(moment(initDate).format('DD/MM/YYYY'))
    } else {
        $('#dateSelected').html(`${moment(initDate).format('DD/MM/YYYY')} - ${moment(endDate).format('DD/MM/YYYY')}`)
    }

    ajax({
        url: 'api/rangeTotalData',
        type: 'POST',
        data: {
            initDate,
            endDate
        }
    }).then(res=> {
        if(res.ok) {
          toastr.success(`${res.ok.length} sacos encontrados`)  
          graphCenters(res.ok)
        } else if(res.err) {
            toastr.warning(res.err)
        }
    })
}

const formatData = (centersData) => {
    let centers = {}
    let centersArr = []
    _.forEach(centersData, (el)=>{
        if (!centers[el.center]) {
            centersArr.push(el.center)
            centers[el.center] = {
                center: el.center,
                totalWeight: el.bag.weight,
                bagsCount: 1,
                bags: [{
                    _id: el._id,
                    weigher: el.weigher,
                    provider: el.provider,
                    weight: el.bag.weight
                }]
            }
        } else {
            centers[el.center].totalWeight += el.bag.weight
            centers[el.center].bagsCount += 1
            centers[el.center].bags.push({
                _id: el._id,
                weigher: el.weigher,
                provider: el.provider,
                weight: el.bag.weight
            })
        }
    })

    console.log(centers,centersArr)
}

const graphCenters = (centersData) => {
    formatData(centersData)
}

</script>
{{/extend}}

